<html><head>
<title>testsystem.py</title>
<meta name="Generator" content="htmlizer/[Twisted, version 22.1.0]" />
<link rel="alternate" href="testsystem.py" type="text/x-python" />

</head>
<body>
<pre><span class="py-src-variable">import</span> <span class="py-src-variable">unittest</span>
<span class="py-src-variable">import</span> <span class="py-src-variable">subprocess</span>

<span class="py-src-variable">def</span> <span class="py-src-identifier">run_case</span>(<span class="py-src-parameter">name</span>):
  <span class="py-src-variable">result</span> = <span class="py-src-variable">subprocess</span>.<span class="py-src-variable">run</span>([<span class="py-src-string">&quot;./lemipc&quot;</span>, <span class="py-src-variable">name</span>])
  <span class="py-src-variable">return</span> <span class="py-src-variable">result</span>.<span class="py-src-variable">returncode</span>

<span class="py-src-variable">class</span> <span class="py-src-identifier">TestIPC</span>(<span class="py-src-parameter">unittest</span>.<span class="py-src-parameter">TestCase</span>):

  <span class="py-src-variable">def</span> <span class="py-src-identifier">test_init_and_clear</span>(<span class="py-src-parameter">self</span>):
    <span class="py-src-variable">self</span>.<span class="py-src-variable">assertEqual</span>(<span class="py-src-variable">run_case</span>(<span class="py-src-string">&quot;test_init_and_clear&quot;</span>), <span class="py-src-number">0</span>)

  <span class="py-src-variable">def</span> <span class="py-src-identifier">test_check_fist_player</span>(<span class="py-src-parameter">self</span>):
    <span class="py-src-variable">self</span>.<span class="py-src-variable">assertEqual</span>(<span class="py-src-variable">run_case</span>(<span class="py-src-string">&quot;test_check_fist_player&quot;</span>), <span class="py-src-number">0</span>)

  <span class="py-src-variable">def</span> <span class="py-src-identifier">test_shm_player</span>(<span class="py-src-parameter">self</span>):
    <span class="py-src-variable">self</span>.<span class="py-src-variable">assertEqual</span>(<span class="py-src-variable">run_case</span>(<span class="py-src-string">&quot;test_shm_player&quot;</span>), <span class="py-src-number">0</span>)

  <span class="py-src-variable">def</span> <span class="py-src-identifier">test_sem_multi_process</span>(<span class="py-src-parameter">self</span>):
      <span class="py-src-string">&quot;&quot;&quot;
      여러 프로세스를 동시에 돌려서 세마포어 / 공유메모리 race condition 확인
      &quot;&quot;&quot;</span>
      <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;------------------test_sem------------------&quot;</span>)
      <span class="py-src-variable">WORKER_COUNT</span> = <span class="py-src-number">5</span>
      <span class="py-src-comment"># 0. 혹시 남아있을 IPC 자원을 먼저 정리 (있으면)</span>
      <span class="py-src-variable">run_case</span>(<span class="py-src-string">&quot;test_sem_clear_ipcs&quot;</span>)
      <span class="py-src-comment"># 1. 워커 여러 개 동시에 실행</span>
      <span class="py-src-variable">procs</span> = []
      <span class="py-src-variable">for</span> <span class="py-src-variable">i</span> <span class="py-src-variable">in</span> <span class="py-src-variable">range</span>(<span class="py-src-variable">WORKER_COUNT</span>):
          <span class="py-src-variable">p</span> = <span class="py-src-variable">subprocess</span>.<span class="py-src-variable">Popen</span>([<span class="py-src-string">&quot;./lemipc&quot;</span>, <span class="py-src-string">&quot;test_sem&quot;</span>])
          <span class="py-src-variable">procs</span>.<span class="py-src-variable">append</span>(<span class="py-src-variable">p</span>)
      <span class="py-src-comment"># 2. 전부 끝날 때까지 대기 + 리턴코드 체크</span>
      <span class="py-src-variable">for</span> <span class="py-src-variable">p</span> <span class="py-src-variable">in</span> <span class="py-src-variable">procs</span>:
          <span class="py-src-variable">p</span>.<span class="py-src-variable">wait</span>()
          <span class="py-src-variable">print</span>(<span class="py-src-string">&quot;worker exit:&quot;</span>, <span class="py-src-variable">p</span>.<span class="py-src-variable">pid</span>, <span class="py-src-variable">p</span>.<span class="py-src-variable">returncode</span>)
          <span class="py-src-variable">self</span>.<span class="py-src-variable">assertEqual</span>(<span class="py-src-variable">p</span>.<span class="py-src-variable">returncode</span>, <span class="py-src-number">0</span>)
      <span class="py-src-comment"># 3. 끝난 후 정리</span>
      <span class="py-src-variable">run_case</span>(<span class="py-src-string">&quot;test_sem_clear_ipcs&quot;</span>)

  <span class="py-src-variable">def</span> <span class="py-src-identifier">test_msq_player</span>(<span class="py-src-parameter">self</span>):
    <span class="py-src-variable">self</span>.<span class="py-src-variable">assertEqual</span>(<span class="py-src-variable">run_case</span>(<span class="py-src-string">&quot;test_msq_player&quot;</span>), <span class="py-src-number">0</span>)


<span class="py-src-variable">if</span> <span class="py-src-variable">__name__</span> == <span class="py-src-string">&quot;__main__&quot;</span>:
  <span class="py-src-variable">unittest</span>.<span class="py-src-variable">main</span>()
</pre>
</body>